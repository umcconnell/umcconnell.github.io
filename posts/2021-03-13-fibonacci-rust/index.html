<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>umcconnell | Fibonacci in Rust</title><link rel="stylesheet" href="/assets/styles/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/themes/prism-tomorrow.css" integrity="sha256-0dkohC9ZEupqWbq0hS5cVR4QQXJ+mp6N2oJyuks6gt0=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha256-tn6hZ2YGDv0w1/DaFL4MiUoXuAVclrtFZs13ch3TB9M=" crossorigin="anonymous"><meta name="description" content="This post goes through different approaches to generating the Fibonacci sequence in Rust. It compares the speed of these approaches using the benchmarking crate criterion.
"><link rel="canonical" href="https://umcconnell.github.io/posts/2021-03-13-fibonacci-rust/"><meta property="og:site_name" content="umcconnell"><meta property="og:title" content="Fibonacci in Rust"><meta property="og:description" content="This post goes through different approaches to generating the Fibonacci sequence in Rust. It compares the speed of these approaches using the benchmarking crate criterion.
"><meta property="og:url" content="https://umcconnell.github.io/posts/2021-03-13-fibonacci-rust/"><meta property="og:locale" content="en_us"><meta name="twitter:card" content="summary"><link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicon/apple-touch-icon.png"><link rel="icon" type="image/png" href="/assets/images/favicon/favicon-32x32.png" sizes="32x32"><link rel="icon" type="image/png" href="/assets/images/favicon/favicon-16x16.png" sizes="16x16"><link rel="shortcut icon" href="/assets/images/favicon/favicon.ico"><link rel="manifest" href="/site.webmanifest"><meta name="theme-color" content="#1a1a1a"><link type="application/atom+xml" rel="alternate" href="https://umcconnell.github.io/feed.xml" title="umcconnell"></head><body><div hidden><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><symbol viewBox="0 0 16 16" id="icon-alert" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"/></symbol><symbol viewBox="0 0 16 16" id="icon-arrow-left" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.78 12.53a.75.75 0 01-1.06 0L2.47 8.28a.75.75 0 010-1.06l4.25-4.25a.75.75 0 011.06 1.06L4.81 7h7.44a.75.75 0 010 1.5H4.81l2.97 2.97a.75.75 0 010 1.06z"/></symbol><symbol viewBox="0 0 16 16" id="icon-check-circle" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M1.5 8a6.5 6.5 0 1113 0 6.5 6.5 0 01-13 0zM0 8a8 8 0 1116 0A8 8 0 010 8zm11.78-1.72a.75.75 0 00-1.06-1.06L6.75 9.19 5.28 7.72a.75.75 0 00-1.06 1.06l2 2a.75.75 0 001.06 0l4.5-4.5z"/></symbol><symbol viewBox="0 0 16 16" id="icon-github" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></symbol><symbol viewBox="0 0 16 16" id="icon-info" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"/></symbol><symbol viewBox="0 0 16 16" id="icon-link" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"/></symbol><symbol viewBox="0 0 16 16" id="icon-link-external" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10.604 1h4.146a.25.25 0 01.25.25v4.146a.25.25 0 01-.427.177L13.03 4.03 9.28 7.78a.75.75 0 01-1.06-1.06l3.75-3.75-1.543-1.543A.25.25 0 0110.604 1zM3.75 2A1.75 1.75 0 002 3.75v8.5c0 .966.784 1.75 1.75 1.75h8.5A1.75 1.75 0 0014 12.25v-3.5a.75.75 0 00-1.5 0v3.5a.25.25 0 01-.25.25h-8.5a.25.25 0 01-.25-.25v-8.5a.25.25 0 01.25-.25h3.5a.75.75 0 000-1.5h-3.5z"/></symbol><symbol viewBox="0 0 16 16" id="icon-pencil" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M11.013 1.427a1.75 1.75 0 012.474 0l1.086 1.086a1.75 1.75 0 010 2.474l-8.61 8.61c-.21.21-.47.364-.756.445l-3.251.93a.75.75 0 01-.927-.928l.929-3.25a1.75 1.75 0 01.445-.758l8.61-8.61zm1.414 1.06a.25.25 0 00-.354 0L10.811 3.75l1.439 1.44 1.263-1.263a.25.25 0 000-.354l-1.086-1.086zM11.189 6.25L9.75 4.81l-6.286 6.287a.25.25 0 00-.064.108l-.558 1.953 1.953-.558a.249.249 0 00.108-.064l6.286-6.286z"/></symbol><symbol viewBox="0 0 16 16" id="icon-rss" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M2.002 2.725a.75.75 0 01.797-.699C8.79 2.42 13.58 7.21 13.974 13.201a.75.75 0 11-1.497.098 10.502 10.502 0 00-9.776-9.776.75.75 0 01-.7-.798zM2 13a1 1 0 112 0 1 1 0 01-2 0zm.84-5.95a.75.75 0 00-.179 1.489c2.509.3 4.5 2.291 4.8 4.8a.75.75 0 101.49-.178A7.003 7.003 0 002.838 7.05z"/></symbol></svg></div><a href="#main" class="sr-skip-link">skip to main content</a><div class="layout" role="document"><header class="header" role="banner"><div class="header__inner container"><div class="header__left"><a href="/" class="header__home-link"><img src="/assets/images/avatar.png" class="header__avatar"> umcconnell</a></div><div class="header__right"><nav class="nav js-nav" role="navigation" tabindex="-1"><button class="nav__toggle js-nav-toggle" aria-expanded="false" aria-controls="nav-menu"><span class="sr-only">toggle menu</span> <span class="menuicon"><span class="menuicon__bar"></span> <span class="menuicon__bar"></span> <span class="menuicon__bar"></span> <span class="menuicon__bar"></span></span></button><ul class="nav__menu js-nav-menu" id="nav-menu"><li class="nav__item"><a class="nav__link" href="/" style="--index:0">Home</a></li><li class="nav__item"><a class="nav__link" href="/about/" style="--index:1">About</a></li><li class="nav__item nav__item--active"><a class="nav__link" href="/posts/" style="--index:2">Posts</a></li><li class="nav__item"><a class="nav__link" href="/projects/" style="--index:3">Projects</a></li></ul></nav></div></div></header><main id="main" class="main" tabindex="-1"><article class="container post"><header class="post__heading"><h1 class="post__title">Fibonacci in Rust</h1><ul class="taglist post__tags"><li class="taglist__tag"><a href="/posts/tags/programming">#programming</a></li><li class="taglist__tag"><a href="/posts/tags/rust">#rust</a></li><li class="taglist__tag"><a href="/posts/tags/fibonacci">#fibonacci</a></li></ul><em class="post__date">Published on March 13, 2021</em><p class="post__description">This post goes through different approaches to generating the Fibonacci sequence in Rust. It compares the speed of these approaches using the benchmarking crate criterion.</p></header><div class="post__content markdown"><p>You’ve probably already heard of the Fibonacci sequence. It is a sequence of numbers named after the mathematician <a href="https://en.wikipedia.org/wiki/Fibonacci" target="_blank" rel="noopener noreferrer">Leonardo of Pisa<svg class="icon icon--link-external" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-link-external"></use></svg></a>, that’s generated using a simple rule, yet pops up in many unexpected places in math and nature, often in relation to the golden ratio.</p><p>To generate the sequence, start with the sequence <code>1, 1</code>. Then, generate the next element in the sequence by adding up the last two elements:</p><ul><li><code>1, 1</code></li><li><code>1, 1, 2</code></li><li><code>1, 1, 2, 3</code></li><li>…</li></ul><p>Mathematically, this can elegantly be expressed using recursion. In this formula, <em>n</em> represents a given position in the sequence starting with <em>0</em>.</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mi>i</mi><mi>b</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.3599999999999999em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi>n</mi><mo>≤</mo><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>f</mi><mi>i</mi><mi>b</mi><mo stretchy="false">(</mo><mi>n</mi><mo>−</mo><mn>2</mn><mo stretchy="false">)</mo><mo>+</mo><mi>f</mi><mi>i</mi><mi>b</mi><mo stretchy="false">(</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi>n</mi><mo>&gt;</mo><mn>1</mn></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">fib(n) = \begin{cases} 1 &amp;\text{if } n \leq 1 \\ fib(n-2)+fib(n-1) &amp;\text{if } n \gt 1 \end{cases}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal">b</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal">b</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal">b</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">1</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><h2 id="implementation" tabindex="-1">Implementation<a href="#implementation" class="anchor-link"><svg class="icon icon--link" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-link"></use></svg></a></h2><p>We will be implementing the Fibonacci logic using Rust. Rust is a programming language initially developed at Mozilla that can guarantee memory safety, while at the same time being super fast. We’ll try out different approaches and see which one runs fastest.</p><p>If you want to follow along on your computer, you can find simple installation instructions for Rust and cargo, the Rust package manager, for just about any OS, on the Rust homepage: <a href="https://www.rust-lang.org/tools/install" target="_blank" rel="noopener noreferrer">https://www.rust-lang.org/tools/install<svg class="icon icon--link-external" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-link-external"></use></svg></a>.</p><p>Alternatively, you can also code along online on the <a href="https://play.rust-lang.org/" target="_blank" rel="noopener noreferrer">Rust playground<svg class="icon icon--link-external" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-link-external"></use></svg></a>without having to install anything!</p><h3 id="setup" tabindex="-1">Setup<a href="#setup" class="anchor-link"><svg class="icon icon--link" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-link"></use></svg></a></h3><div class="msg msg--info"><p>If you are not coding along on your machine, feel free to skip this section.</p></div><p>First, let’s create a new Rust library project from the command-line using cargo:</p><pre class="language-bash"><code class="language-bash">cargo new --lib rust_fibonacci<br><span class="token builtin class-name">cd</span> rust_fibonacci/</code></pre><p>The file <code>src/lib.rs</code> is where we’ll be writing source code later on. You can delete it’s pregenerated contents for now, as we won’t go through writing tests for such a simple program.</p><p>Now, the only aspect missing is the benchmarking, so that we can compare the different approaches to calculating the Fibonacci sequence. To do this, we can use the <a href="https://docs.rs/crate/criterion/0.3.3" target="_blank" rel="noopener noreferrer">criterion crate<svg class="icon icon--link-external" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-link-external"></use></svg></a>, which allows us to write benchmarks and run them using cargo. Add the following code to the <code>Cargo.toml</code> file, just below the <code>[dependencies]</code> section at the bottom:</p><pre class="language-toml"><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">dev-dependencies</span><span class="token punctuation">]</span><br><span class="token key property">criterion</span> <span class="token punctuation">=</span> <span class="token string">"0.3"</span><br><br><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token table class-name">bench</span><span class="token punctuation">]</span><span class="token punctuation">]</span><br><span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"fibonacci_benchmark"</span><br><span class="token key property">harness</span> <span class="token punctuation">=</span> <span class="token boolean">false</span></code></pre><p>Create a directory called <code>benches</code> in the base directory and place an empty file called <code>fibonacci_benchmark.rs</code> into it.</p><p>Once you’re done, the <code>rust_fibonacci/</code> project directory content should look something like this:</p><pre><code>.
├── benches
│   └── fibonacci_benchmark.rs
├── Cargo.lock
├── Cargo.toml
└── src
    └── lib.rs
</code></pre><h2 id="1-standard" tabindex="-1">#1: Standard<a href="#1-standard" class="anchor-link"><svg class="icon icon--link" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-link"></use></svg></a></h2><div class="msg msg--info"><div class="msg__header">INFO</div>If you're using the Rust playground, just add all the code examples above the `main` function. The playground just allows you to use one single file to write your code in.</div><p>Now, let’s get coding! Probably the most straightforward way to implement the Fibonacci sequence, would be to just start with two variables <code>a</code> and <code>b</code>, that keep track of the last two elements of the sequence and build from there. Let’s do that! Add this code to <code>src/lib.rs</code>:</p><pre class="language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">fib_standard</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">usize</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> <span class="token keyword">mut</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><br>    <span class="token keyword">let</span> <span class="token keyword">mut</span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span>n <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> old <span class="token operator">=</span> a<span class="token punctuation">;</span><br>        a <span class="token operator">=</span> b<span class="token punctuation">;</span><br>        b <span class="token operator">+=</span> old<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    b<br><span class="token punctuation">}</span></code></pre><p>Notice the <code>pub</code> keyword: We use it, so that we can import the code from other files. This will be useful when benchmarking the functions later on.</p><p>Here, we declare <code>a</code> and <code>b</code> as <code>mut</code>, i.e. <em>mutable</em>, to allow us to mutate or change their values. In Rust, all variables are <em>imutable</em> by default.</p><p>We start our loop at <code>1</code>, because the first two values are already defined and the range is non-inclusive for its end.</p><h2 id="2-recursion" tabindex="-1">#2: Recursion<a href="#2-recursion" class="anchor-link"><svg class="icon icon--link" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-link"></use></svg></a></h2><p>Another approach to implementing the Fibonacci algorithm would be to just translate the recursive mathematical definition from the introduction into Rust code. Add the following function in <code>src/lib.rs</code>:</p><pre class="language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">fib_recursive</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">usize</span> <span class="token punctuation">{</span><br>    <span class="token keyword">match</span> n <span class="token punctuation">{</span><br>        <span class="token number">0</span> <span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">=></span> <span class="token number">1</span><span class="token punctuation">,</span><br>        _ <span class="token operator">=></span> <span class="token function">fib_recursive</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">fib_recursive</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>In this case, the match operator comes in really handy. It works just like the conditional function definition in math! It is short, clean and concise. This means we don’t have to write endless <code>if { ... } else if { ... } else { ... }</code> clauses.</p><p>One last thing to note, is the implicit return. We did not have to use the <code>return</code> statement, because the last expression is automatically returned. However, it is important not to end with a semi-colon, which would make the function return nothing (or <code>()</code>, to be more precise).</p><p>When we take a close look at this function, it might become clear that it is pretty inefficient. When calculating <code>fib_recursive(n)</code>, we end up calculating the Fibonacci sequence twice every step down from <code>n</code>, although it would be enough to calculate the sequence once. This is where <a href="https://en.wikipedia.org/wiki/Memoization" target="_blank" rel="noopener noreferrer">memoization<svg class="icon icon--link-external" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-link-external"></use></svg></a>comes in.</p><div class="msg msg--info"><div class="msg__header">Runtime complexity</div><p>The recursive approach has the runtime complexity <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mn>2</mn><mi>n</mi></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(2^n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>.</p><p>This is because the time complexity of <code>fib_recursive(n)</code> <em>approximately doubles</em> for every <code>n</code>, because it computes <code>fib_recursive(n-1)</code> and <code>fib_recursive(n-2)</code>.</p><p>If we want to be more exact about the statement “it approximately doubles”, we can say the following about this factor <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span></span></span></span>:</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left right left" columnspacing="0em 1em 0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msup><mi>a</mi><mi>n</mi></msup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msup><mi>a</mi><mrow><mo stretchy="false">(</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mo lspace="0em" rspace="0em">+</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msup><mi>a</mi><mrow><mo stretchy="false">(</mo><mi>n</mi><mo>−</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mspace width="1em"><mi mathvariant="normal">∣</mi><mo>:</mo><msup><mi>a</mi><mrow><mo stretchy="false">(</mo><mi>n</mi><mo>−</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msup><mi>a</mi><mn>2</mn></msup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>a</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mo lspace="0em" rspace="0em">+</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>a</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mrow><mn>1</mn><mo>±</mo><msqrt><mn>5</mn></msqrt></mrow><mn>2</mn></mfrac></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned} a^n &amp;= a^{(n-1)} &amp;+ &amp;a^{(n-2)} \quad | : a^{(n-2)} \\ a^2 &amp;= a &amp;+ &amp;1 \\ a &amp;= \frac{1 \pm \sqrt{5}}{2} \end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:5.692328000000001em;vertical-align:-2.596164000000001em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.096164em;"><span style="top:-5.742384em;"><span class="pstrut" style="height:3.58422em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7143919999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span><span style="top:-4.218276em;"><span class="pstrut" style="height:3.58422em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-1.9740559999999996em;"><span class="pstrut" style="height:3.58422em;"></span><span class="mord"><span class="mord mathnormal">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.596164000000001em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.096164em;"><span style="top:-5.742384em;"><span class="pstrut" style="height:3.58422em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span><span style="top:-4.218276em;"><span class="pstrut" style="height:3.58422em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">a</span></span></span><span style="top:-1.9740559999999996em;"><span class="pstrut" style="height:3.58422em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5842200000000002em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">±</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.90722em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord">5</span></span></span><span style="top:-2.86722em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.13278em;"><span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.596164000000001em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.096164em;"><span style="top:-5.158164em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">+</span></span></span><span style="top:-3.634056em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">+</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.025943999999999967em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.096164em;"><span style="top:-5.158164em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">2</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">2</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.634056em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.025943999999999967em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>We can safely ignore the second solution <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mn>1</mn><mo>−</mo><msqrt><mn>5</mn></msqrt></mrow><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{1 - \sqrt{5}}{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3829999999999998em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0379999999999998em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.3990085em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.912845em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mtight">5</span></span></span><span style="top:-2.872845em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.12715500000000002em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>, which is negative. This leaves us with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>=</mo><mfrac><mrow><mn>1</mn><mo>+</mo><msqrt><mn>5</mn></msqrt></mrow><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">a = \frac{1 + \sqrt{5}}{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.3829999999999998em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0379999999999998em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.3990085em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">+</span><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.912845em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mtight">5</span></span></span><span style="top:-2.872845em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.12715500000000002em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>, the <a href="https://en.wikipedia.org/wiki/Golden_ratio" target="_blank" rel="noopener noreferrer">golden ratio<svg class="icon icon--link-external" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-link-external"></use></svg></a>. What a coincidence! The asymptotically tight bound on the running time of <code>fib_recursive</code> is thus <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Θ</mi><mo stretchy="false">(</mo><msup><mi>a</mi><mi>n</mi></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Theta(a^n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Θ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span></span></span></span> is the golden ratio.</p><p>You can find out more about asymptotic notation in computer science on <a href="https://www.khanacademy.org/computing/computer-science/algorithms/asymptotic-notation/a/asymptotic-notation" target="_blank" rel="noopener noreferrer">Khan Academy<svg class="icon icon--link-external" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-link-external"></use></svg></a>.</p></div><h2 id="3-memoization" tabindex="-1">#3: Memoization<a href="#3-memoization" class="anchor-link"><svg class="icon icon--link" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-link"></use></svg></a></h2><p>We will use a <a href="https://doc.rust-lang.org/std/collections/struct.HashMap.html" target="_blank" rel="noopener noreferrer">std::collections::HashMap<svg class="icon icon--link-external" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-link-external"></use></svg></a>, which is similar to a <code>dict</code> in Python or an <code>Object</code> in JavaScript, to keep track of all the values we’ve already calculated. Then, we can quickly check, whether a given value has already been encountered and can return this, before wasting time on a redundant calculation. Add this code to your <code>lib.rs</code> file:</p><pre class="language-rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span><br><br><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">fib_memoization</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> memo<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token punctuation">,</span> <span class="token keyword">usize</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">usize</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">=</span> memo<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token operator">*</span>v<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token keyword">match</span> n <span class="token punctuation">{</span><br>        <span class="token number">0</span> <span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">=></span> <span class="token number">1</span><span class="token punctuation">,</span><br>        _ <span class="token operator">=></span> <span class="token function">fib_memoization</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> memo<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">fib_memoization</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> memo<span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>    memo<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    v<br><span class="token punctuation">}</span></code></pre><p>We first check, whether the current <em>n</em> is in the HashMap, by checking whether the value at <em>n</em> is <code>Some</code>. If no value has jet been recorded, <code>memo.get(&amp;n)</code> will return <code>None</code> and the pattern won’t match.</p><p>Next, we compute the sequence value just as when using plain recursion. The only difference is, that we save the value to our memo before returning it.</p><p>Notice how we write <code>&amp;mut HashMap&lt;usize, usize&gt;</code> in the function definition. This is part of Rust’s borrow checker, that ensure memory safety for our program. By declaring the memo as <em>mutable</em>, Rust ensures that only one part of the program has write access at a time and that no other part of the program can read from the memo while we have write access to it and might be modifying it unexpectedly.</p><h2 id="4-iterator" tabindex="-1">#4: Iterator<a href="#4-iterator" class="anchor-link"><svg class="icon icon--link" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-link"></use></svg></a></h2><p>One last way to implement the Fibonacci sequence that this post will cover is using Rust iterators. You might be familiar with this concept, especially if you’ve already used <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Generator" target="_blank" rel="noopener noreferrer">Generators in JavaScript<svg class="icon icon--link-external" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-link-external"></use></svg></a>or <a href="https://docs.python.org/3/library/stdtypes.html#iterator-types" target="_blank" rel="noopener noreferrer">Iterators in Python<svg class="icon icon--link-external" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-link-external"></use></svg></a>.</p><p>Rust iterators implement the <a href="https://doc.rust-lang.org/std/iter/trait.Iterator.html" target="_blank" rel="noopener noreferrer"><code>Iterator</code> trait<svg class="icon icon--link-external" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-link-external"></use></svg></a>and expose a <code>next</code> function, which returns the next element of the iterator or <code>None</code>, if the iteration is over.</p><p>Lets implement this iterator principle using a <code>struct</code>. The struct will save the last two elements <code>a</code> and <code>b</code> of the sequence, starting at <code>1</code>. It will then generate the next value just as in the standard approach:</p><pre class="language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">FibIterator</span> <span class="token punctuation">{</span><br>    a<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span><br>    b<span class="token punctuation">:</span> <span class="token keyword">usize</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">impl</span> <span class="token class-name">Default</span> <span class="token keyword">for</span> <span class="token class-name">FibIterator</span> <span class="token punctuation">{</span><br>    <span class="token keyword">fn</span> <span class="token function-definition function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">{</span><br>        <span class="token class-name">FibIterator</span> <span class="token punctuation">{</span> a<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">impl</span> <span class="token class-name">Iterator</span> <span class="token keyword">for</span> <span class="token class-name">FibIterator</span> <span class="token punctuation">{</span><br>    <span class="token keyword">type</span> <span class="token class-name">Item</span> <span class="token operator">=</span> <span class="token keyword">usize</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">fn</span> <span class="token function-definition function">next</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Item</span><span class="token operator">></span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> curr <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>a<span class="token punctuation">;</span><br>        <span class="token keyword">self</span><span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>b<span class="token punctuation">;</span><br>        <span class="token keyword">self</span><span class="token punctuation">.</span>b <span class="token operator">=</span> curr <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>a<span class="token punctuation">;</span><br><br>        <span class="token class-name">Some</span><span class="token punctuation">(</span>curr<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>A few things to notice here. First, notice how we all methods of the struct are wrapped in <code>impl</code> blocks. This separates the struct definition from it’s methods, helping your code stay clean.</p><p>Also, we write a default method that takes no arguments and returns an initialized <code>FibIterator</code>. As this method is not associated to a struct instance, i.e. an initialized <code>FibIterator</code> with concrete values for <code>a</code> and <code>b</code>, it is called an <em>associated function</em>. We can call these types of functions using <code>::</code>. In this case, we would call <code>FibIterator::default()</code> to construct a new instance.</p><p>The <code>Iterator</code> and <code>Default</code> traits are implemented using the <code>impl Foo for Bar</code> statement. In the <code>impl</code> block of the <code>Iterator</code> trait, we define a next function that just returns the sum of the two last elements in the sequence. This way, the iterator can just keep generating new integers of the sequence <strong>on demand</strong>. Because iterators in Rust are lazy, these integers are only generated when needed.</p><div class="msg msg--info"><div class="msg__header">INFO</div><p>A trait is a set of common functions all structs must implement, to have this trait. In the case of <code>Iterator</code>, this is solely the <code>next</code> function.</p><p>Traits are useful, because they allow other functions to accept different types, while making sure that all of these different types share a common interface.</p><p>When implementing <code>Iterator</code>, this trait unlocks a whole set of other useful methods such as <code>skip</code>, <code>take</code>, <code>filter</code>, and many more, that all rely on the <code>next</code> method we implemented. These all come built-in with the trait and we don’t need any additional work to implement these.</p><p>Iterators are an important part of Rust, as they allow to write code in a concise functional style, while incurring no additional performance. When compiling the code, Rust will optimize the operations away and turn the iterators into classical for loops in the background. That means you don’t have to choose between writing fast and clean code, you can do both!</p></div><h2 id="bechmarking" tabindex="-1">Bechmarking<a href="#bechmarking" class="anchor-link"><svg class="icon icon--link" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-link"></use></svg></a></h2><p>Finally, we will compare the different approaches by benchmarking the different functions. Add the following code to the <code>benches/fibonacci_benchmark.rs</code> file. Note that benchmarking does not seem possible on the online Rust playground.</p><pre class="language-rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">criterion<span class="token punctuation">::</span></span><span class="token punctuation">{</span>criterion_group<span class="token punctuation">,</span> criterion_main<span class="token punctuation">,</span> <span class="token class-name">BenchmarkId</span><span class="token punctuation">,</span> <span class="token class-name">Criterion</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">rust_fibonacci<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span><br><br><span class="token keyword">fn</span> <span class="token function-definition function">bench_fibs</span><span class="token punctuation">(</span>c<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Criterion</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> <span class="token keyword">mut</span> group <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">benchmark_group</span><span class="token punctuation">(</span><span class="token string">"Fibonacci"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        group<span class="token punctuation">.</span><span class="token function">bench_with_input</span><span class="token punctuation">(</span><span class="token class-name">BenchmarkId</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Standard"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>b<span class="token punctuation">,</span> i<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span><br>            b<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token function">fib_standard</span><span class="token punctuation">(</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        group<span class="token punctuation">.</span><span class="token function">bench_with_input</span><span class="token punctuation">(</span><span class="token class-name">BenchmarkId</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Recursion"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>b<span class="token punctuation">,</span> i<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span><br>            b<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token function">fib_recursive</span><span class="token punctuation">(</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        group<span class="token punctuation">.</span><span class="token function">bench_with_input</span><span class="token punctuation">(</span><span class="token class-name">BenchmarkId</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Memoization"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>b<span class="token punctuation">,</span> i<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span><br>            b<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span><br>                <span class="token keyword">let</span> <span class="token keyword">mut</span> memo <span class="token operator">=</span> <span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token function">fib_memoization</span><span class="token punctuation">(</span><span class="token operator">*</span>i<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> memo<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        group<span class="token punctuation">.</span><span class="token function">bench_with_input</span><span class="token punctuation">(</span><span class="token class-name">BenchmarkId</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Iterator"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>b<span class="token punctuation">,</span> i<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span><br>            b<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span><br>                <span class="token class-name">FibIterator</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nth</span><span class="token punctuation">(</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    group<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token macro property">criterion_group!</span><span class="token punctuation">(</span>benches<span class="token punctuation">,</span> bench_fibs<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token macro property">criterion_main!</span><span class="token punctuation">(</span>benches<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>This code creates a test group called <code>Fibonacci</code> and benchmarks the four different approaches using the same input. Run the benchmark in your terminal:</p><pre class="language-bash"><code class="language-bash">cargo bench</code></pre><p>Once the benchmarks are done, you can view a nice HTML report in your browser by opening <code>target/criterion/Fibonacci/report/index.html</code>. Running on my machine gave me the following stats:</p><p><img src="/assets/images/posts/fibonacci-rust/perf_plot.svg" alt="Performance plot of the different methods"></p><p>You can clearly see, that the naive recursive solution is the least performant approach, as its execution time increases (exponentially, but not visible with 2 inputs) with the workload. The memoized version, in contrast, shows a great improvement, but it still incurs the performance overhead of initializing and managing the memo, making it less performant than the two last approaches.</p><p>The iterator and standard seem to be indistinguishable. On my machine, the execution of the iterator takes <code>~34ns</code> for both inputs, the standard approach around <code>~4.5ns</code> for both inputs.</p><p>You can find more detailed graphs and charts for every function in the corresponding <code>target/criterion/Fibonacci/&lt;APPROACH&gt;/report/index.html</code> folder.</p><h2 id="conclusion" tabindex="-1">Conclusion<a href="#conclusion" class="anchor-link"><svg class="icon icon--link" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-link"></use></svg></a></h2><p>We’ve implemented and benchmarked four different approaches to generating the Fibonacci sequence.</p><p>Although the recursive solution is short and concise, it is by far the least performant and can become too slow to calculate for larger inputs. The memoized solution is interesting, in that it combines the conciseness of the recursive approach with a greater speed. The standard approach, on the other hand, seems to be the fastest, but it is arguably the least elegant.</p><p>Finally, the iterator solution appears to be by far the most versatile while at the same time being very fast. Additionally, it allows the user to work with the sequence in a very convenient way, e.g. by filtering, mapping, etc.</p><p>Overall, it becomes clear that iterators are a very versatile and performant aspect of Rust, that are also worth considering in other languages such as Python or JavaScript.</p><p>The final code of this project is open source and available here: <a href="https://github.com/umcconnell/rust_fibonacci" target="_blank" rel="noopener noreferrer">https://github.com/umcconnell/rust_fibonacci<svg class="icon icon--link-external" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-link-external"></use></svg></a></p><p>Feedback, questions, comments or improvements are welcome!</p><p>Thanks for reading.</p></div><footer class="post__footer"><div class="links"><a href="/posts/" class="back"><svg class="icon icon--arrow-left" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-arrow-left"></use></svg>Back to Posts</a> <a href="https://github.com/umcconnell/umcconnell.github.io/blob/main/./src/posts/2021-03-13-fibonacci-rust.md" class="edit" target="_blank"><svg class="icon icon--pencil" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-pencil"></use></svg>Edit on Github</a></div><div class="post__comments"><h2>Comments</h2><script src="https://utteranc.es/client.js" repo="umcconnell/comments" issue-term="pathname" label="comment" theme="preferred-color-scheme" crossorigin="anonymous" async></script></div></footer></article></main><footer class="footer" role="contentinfo"><div class="footer__inner container"><div class="footer__left">&copy; Copyright 2022 Ulysse McConnell<p>Code: <a rel="license noopener noreferrer" href="https://github.com/umcconnell/umcconnell.github.io/blob/main/LICENSE" target="_blank">MIT License</a>, Content: <a rel="license noopener noreferrer" href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank"><img alt="Creative Commons License" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" style="border-width:0" width="80" height="15"></a></p><p>Built with <a rel="noopener noreferrer" href="https://11ty.dev" target="_blank">11ty</a>, using the <a rel="noopener noreferrer" href="https://github.com/maxboeck/eleventastic" target="_blank">eleventastic</a> template.</p><p>Commit #<a rel="noopener noreferrer" href="https://github.com/umcconnell/umcconnell.github.io/commit/7dafe1d30727099e2cfda6c789155685ac6cd2eb" target="_blank">7dafe1d</a> (<a href="/build.txt">Build info</a>)</p></div><div class="footer__right"><a href="https://github.com/umcconnell/"><svg class="icon icon--github" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-github"></use></svg></a><a href="/feed.xml"><svg class="icon icon--rss" role="img" aria-hidden="true" width="24" height="24"><use xlink:href="#icon-rss"></use></svg></a></div></div></footer></div><script type="text/javascript" src="/assets/scripts/main.js"></script></body></html>